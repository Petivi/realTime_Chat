<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <title>Chat</title>
</head>

<body id="body">
    <h1>Secret Chat</h1>
    <div class="">
      <h2 id="roomNameTitle"></h2>
    </div>
    <div style="display: none" id="contentMessage">
        <textarea style="width: 100%;" id="message" rows="4"></textarea>
        <button id="btn-send-msg">Envoyer</button>
        <div id="affichage"></div>
    </div>
    <div id="contentPseudo">
        <label for="pseudo">Pseudo *</label>
        <input type="text" id="pseudo" name="pseudo">
    </div>
    <div id="contentRoomName" style="margin:1em 0 1em 0;">
        <label for="room">Room *</label>
        <input type="text" id="room" name="room">
    </div>
    <div id="contentBtnValider">
      <button id="btn-valider-connection">Valider</button>
    </div>


    <script>
        var socket = io({
            transports: ['websocket'],
            upgrade: false
        });
        var body = document.getElementById('body');
        var btnValiderConnection = document.getElementById('btn-valider-connection');
        var pseudo = document.getElementById('pseudo');
        var room = document.getElementById('room');
        var contentPseudo = document.getElementById('contentPseudo');
        var contentRoomName = document.getElementById('contentRoomName');
        var contentBtnValider = document.getElementById('contentBtnValider');
        var message = document.getElementById('message');
        var affichage = document.getElementById('affichage');
        var roomNameTitle = document.getElementById('roomNameTitle');
        var contentMessage = document.getElementById('contentMessage');
        var btnSendMsg = document.getElementById('btn-send-msg');

        btnValiderConnection.addEventListener('click', (e) => {
          if(pseudo.value != "" && room.value != ""){
            connectToRoom();
          }
        });

        body.addEventListener('keyup', (e) => {
            if (e.keyCode === 13 && pseudo.value != "" && room.value != "") {
                connectToRoom();
            }
        });

        btnSendMsg.addEventListener('click', (e) => {
            sendMessage();
        });

        message.addEventListener('keyup', (e) => {
            if (e.keyCode === 13) {
                sendMessage();
            }
        });

        socket.on('event', (data) => {
            affichage.innerHTML += '<br><strong>' + data.pseudo + '</strong> : ' + data.text;
        });

        socket.on('roomJoin', (data) => {
          console.log('oui');
            roomNameTitle.innerHTML = '<strong> Room Name : ' + data.room + '</strong>';
            affichage.innerHTML += '<br><strong>' + data.text + '</strong>';
        });

        socket.on('userJoin', (data) => {
            affichage.innerHTML += '<br><strong>' + data.text + '</strong>';
        });

        function connectToRoom() {
            socket.emit('connectToRoom', {pseudo:pseudo.value,room:room.value});
            contentPseudo.style.display = 'none';
            contentRoomName.style.display = 'none';
            contentBtnValider.style.display = 'none';
            contentMessage.style.display = 'block';
        }

        function sendMessage() {
            socket.emit('sendMessage', message.value);
            message.value = '';
        }
    </script>

</body>

</html>
