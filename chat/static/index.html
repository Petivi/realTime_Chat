<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="js/socketio.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/styles.css">
    <title>Chat</title>
</head>

<body id="body">
    <div class="container page">
        <div class="row">
            <div class="col-md-2">
                <div class="card">
                    <div class="card-header">
                        Menu
                    </div>
                    <div class="card-body">
                        <a href="qpc.html">Question pour un BOSS !</a>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h1>Secret Chat</h1>
                    </div>
                    <div class="card-body">
                        <div style="display: none" id="contentMessage">
                            <div class="row">
                                <div class="col-md-7">
                                    <h2 id="roomNameTitle"></h2>
                                </div>
                                <div class="col-md-2 text-right">
                                    <button id="btnLeave">Quitter la salle</button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col">
                                                    <textarea autofocus placeholder="Taper votre message" class="textArea" id="message" rows="1"></textarea>
                                                </div>
                                                <div class="col-md-auto text-right">
                                                    <button id="btn-send-msg">Envoyer</button>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col">
                                                    <div id="affichage"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>Liste des utilisateurs :</h5>
                                            <ul id="listUsers"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="divInfosUser">
                            <div id="contentPseudo">
                                <label for="pseudo">Pseudo *</label>
                                <input autofocus type="text" id="pseudo" name="pseudo">
                            </div>
                            <div id="contentRoomName" style="margin:1em 0 1em 0;">
                                <label for="room">Room *</label>
                                <input type="text" id="room" name="room">
                            </div>
                            <div id="contentBtnValider">
                                <button id="btn-valider-connection">Valider</button>
                            </div>
                        </div>
                        <div id="divInfosRooms">
                            <div id="contentListRooms">
                                <h5>Liste des rooms actives</h5>
                                <ul id="listRooms"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var socket = io({
            transports: ['websocket'],
            upgrade: false
        });
        var btnValiderConnection = document.getElementById('btn-valider-connection');
        var pseudo = document.getElementById('pseudo');
        var room = document.getElementById('room');
        var divInfosRooms = document.getElementById('divInfosRooms');
        var divInfosUser = document.getElementById('divInfosUser');
        var message = document.getElementById('message');
        var affichage = document.getElementById('affichage');
        var roomNameTitle = document.getElementById('roomNameTitle');
        var contentMessage = document.getElementById('contentMessage');
        var btnSendMsg = document.getElementById('btn-send-msg');
        var btnLeave = document.getElementById('btnLeave');
        var classSender = "";
        var listRooms = document.getElementById('listRooms');
        var listUsers = document.getElementById('listUsers');

        btnValiderConnection.addEventListener('click', (e) => {
            if (pseudo.value != "" && room.value != "") {
                connectToRoom();
            }
        });

        room.addEventListener('keyup', (e) => {
            if (e.keyCode === 13 && pseudo.value != "" && room.value != "") {
                connectToRoom();
            }
        });

        pseudo.addEventListener('keyup', (e) => {
            if (e.keyCode === 13 && pseudo.value != "" && room.value != "") {
                connectToRoom();
            }
        });

        btnSendMsg.addEventListener('click', (e) => {
            sendMessage();
        });

        message.addEventListener('keydown', (e) => {
            let value = message.value;
            let numberOfLineBreaks = (value.match(/\n/g) || []).length;
            console.log(numberOfLineBreaks)
            if (e.keyCode === 13) {
                sendMessage();
            }
        });

        socket.on('event', (data) => {
            affichage.innerHTML += '<br><strong>' + data.pseudo + '</strong> : ' + data.text; // message
        });

        socket.on('roomJoin', (data) => {
            roomNameTitle.innerHTML = '<strong> Room Name : ' + data.room + '</strong>'; // affichage nom room
            displayInfoRoom(data);
        });

        socket.on('userJoin', (data) => {
            displayInfoRoom(data);
        });

        socket.on('userLeave', (data) => {
            displayInfoRoom(data);
        });

        socket.on('updateListUsers', (data) => {
            listUsers.innerHTML = "";
            data.forEach(function(tab) {
                var li = document.createElement('li');
                li.innerHTML = tab;
                listUsers.appendChild(li);
            });
        });

        socket.on('roomsInfo', (data) => {
            data.forEach(function(tab) {
                var li = document.createElement('li');
                li.innerHTML = tab.name + " (" + tab.users.length + ")";
                listRooms.appendChild(li);
            });
        });

        function displayInfoRoom(data) {
            affichage.innerHTML += '<br><strong>' + data.text + '</strong>'; // affichage user join room
        }

        function connectToRoom() {
            socket.emit('connectToRoom', {
                pseudo: pseudo.value,
                room: room.value
            });
            divInfosRooms.style.display = 'none';
            divInfosUser.style.display = 'none';
            contentMessage.style.display = 'block';
        }

        function sendMessage() {
            if (message.value !== '') {
                socket.emit('sendMessage', message.value);
                message.value = '';
            }
        }
    </script>

</body>

</html>