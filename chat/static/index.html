<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="js/socketio.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/styles.css">
    <title>Chat</title>
</head>

<body id="body">
    <div class="row">
        <div class="col-md-2">
            menu
        </div>
        <div class="col">
            <h1>Secret Chat</h1>
            <div class="">
                <h2 id="roomNameTitle"></h2>
            </div>
            <div style="display: none" id="contentMessage">
              <textarea style="width: 100%;" id="message" rows="4"></textarea>
              <button id="btn-send-msg">Envoyer</button>
              <div class="row">
                <div class="col-sm-9">
                  <fieldset class="customFieldset">
                    <div id="affichage"></div>
                  </fieldset>
                </div>
                <div class="col-sm-3">
                  <fieldset class="customFieldset">
                    <h5>Liste des utilisateurs :</h5>
                    <ul id="listUsers"></ul>
                  </fieldset>
                </div>
              </div>
            </div>
            <div id="divInfosUser">
              <div id="contentPseudo">
                <label for="pseudo">Pseudo *</label>
                <input type="text" id="pseudo" name="pseudo">
              </div>
              <div id="contentRoomName" style="margin:1em 0 1em 0;">
                <label for="room">Room *</label>
                <input type="text" id="room" name="room">
              </div>
              <div id="contentBtnValider">
                <button id="btn-valider-connection">Valider</button>
              </div>
            </div>
            <div id="divInfosRooms">
              <div id="contentListRooms">
                <h5>Liste des rooms actives</h5>
                <ul id="listRooms"></ul>
              </div>
            </div>
        </div>
    </div>

    <script>
        var socket = io({
            transports: ['websocket'],
            upgrade: false
        });
        var btnValiderConnection = document.getElementById('btn-valider-connection');
        var pseudo = document.getElementById('pseudo');
        var room = document.getElementById('room');
        // var contentPseudo = document.getElementById('contentPseudo');
        // var contentRoomName = document.getElementById('contentRoomName');
        // var contentBtnValider = document.getElementById('contentBtnValider');
        // var contentListRooms = document.getElementById('contentListRooms');
        var divInfosRooms = document.getElementById('divInfosRooms');
        var divInfosUser = document.getElementById('divInfosUser');
        var message = document.getElementById('message');
        var affichage = document.getElementById('affichage');
        var roomNameTitle = document.getElementById('roomNameTitle');
        var contentMessage = document.getElementById('contentMessage');
        var btnSendMsg = document.getElementById('btn-send-msg');
        var classSender = "";
        var listRooms = document.getElementById('listRooms');
        var listUsers = document.getElementById('listUsers');

        btnValiderConnection.addEventListener('click', (e) => {
            if (pseudo.value != "" && room.value != "") {
                connectToRoom();
            }
        });

        room.addEventListener('keyup', (e) => {
            if (e.keyCode === 13 && pseudo.value != "" && room.value != "") {
                connectToRoom();
            }
        });

        pseudo.addEventListener('keyup', (e) => {
            if (e.keyCode === 13 && pseudo.value != "" && room.value != "") {
                connectToRoom();
            }
        });

        btnSendMsg.addEventListener('click', (e) => {
            sendMessage();
        });

        message.addEventListener('keyup', (e) => {
            if (e.keyCode === 13) {
                sendMessage();
            }
        });

        socket.on('event', (data) => {
            affichage.innerHTML += '<br><strong>' + data.pseudo + '</strong> : ' + data.text; // message
        });

        socket.on('roomJoin', (data) => {
            roomNameTitle.innerHTML = '<strong> Room Name : ' + data.room + '</strong>'; // affichage nom room
            affichage.innerHTML += '<br><strong>' + data.text + '</strong>'; // affichage message room rejointe
        });

        socket.on('userJoin', (data) => {
            affichage.innerHTML += '<br><strong>' + data.text + '</strong>'; // affichage user join room
        });

        socket.on('updateListUsers', (data) => {
            listUsers.innerHTML = "";
            data.forEach(function(tab) {
              var li = document.createElement('li');
              li.innerHTML = tab;
              listUsers.appendChild(li);
            });
        });

        socket.on('roomsInfo', (data) => {
          data.forEach(function(tab) {
            var li = document.createElement('li');
            li.innerHTML = tab.name + " ("+tab.users.length+")";
            listRooms.appendChild(li);
          });
        });

        function connectToRoom() {
            socket.emit('connectToRoom', { pseudo: pseudo.value, room: room.value });
            // contentPseudo.style.display = 'none';
            // contentRoomName.style.display = 'none';
            // contentBtnValider.style.display = 'none';
            // contentListRooms.style.display = 'none';
            divInfosRooms.style.display = 'none';
            divInfosUser.style.display = 'none';
            contentMessage.style.display = 'block';
        }

        function sendMessage() {
            socket.emit('sendMessage', message.value);
            message.value = '';
        }
    </script>

</body>

</html>
