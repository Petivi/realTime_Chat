<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <title>Chat</title>
</head>

<body>
    <h1>Secret Chat</h1>
    <div style="display: none" id="contentMessage">
        <textarea style="width: 100%;" id="message" rows="4"></textarea>
        <button id="btn-send-msg">Envoyer</button>
        <div id="affichage"></div>
    </div>
    <div id="contentPseudo">
        <label for="pseudo">Pseudo *</label>
        <input type="text" id="pseudo" name="pseudo">
        <button id="btn-valider-pseudo">Valider</button>
    </div>
    <div id="contentRoomName" style="margin:1em 0 1em 0;">
        <label for="room">Room</label>
        <input required type="text" id="room" name="room">
        <button id="btn-valider-room">Valider</button>
    </div>


    <script>
        var socket = io({
            transports: ['websocket'],
            upgrade: false
        });
        var btnValiderPseudo = document.getElementById('btn-valider-pseudo');
        var pseudo = document.getElementById('pseudo');
        var contentPseudo = document.getElementById('contentPseudo');
        var message = document.getElementById('message');
        var affichage = document.getElementById('affichage');
        var contentMessage = document.getElementById('contentMessage');
        var btnSendMsg = document.getElementById('btn-send-msg');

        btnValiderPseudo.addEventListener('click', (e) => {
          if(pseudo.value != ""){
            connectToRoom();
          }
        });

        pseudo.addEventListener('keyup', (e) => {
            if (e.keyCode === 13 && pseudo.value != "") {
                connectToRoom();
            }
        });

        btnSendMsg.addEventListener('click', (e) => {
            sendMessage();
        });

        message.addEventListener('keyup', (e) => {
            if (e.keyCode === 13) {
                sendMessage();
            }
        });

        socket.on('event', (data) => {
            affichage.innerHTML += '<br><strong>' + data.pseudo + '</strong> : ' + data.text;
        });

        function connectToRoom() {
            socket.emit('choosePseudo', pseudo.value);
            contentPseudo.style.display = 'none';
            contentMessage.style.display = 'block';
        }

        function sendMessage() {
            socket.emit('sendMessage', message.value);
            message.value = '';
        }
    </script>

</body>

</html>
